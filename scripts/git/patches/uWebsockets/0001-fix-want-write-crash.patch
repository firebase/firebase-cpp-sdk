From fe5f7b393233b95b2c5ba66f74de1d435124373e Mon Sep 17 00:00:00 2001
From: "google.com" <google.com>
Date: Fri, 2 Jul 2021 11:31:55 -0400
Subject: [PATCH] fix want_write crash

---
 src/Socket.h | 30 ++++++++++++++++--------------
 1 file changed, 16 insertions(+), 14 deletions(-)

diff --git a/src/Socket.h b/src/Socket.h
index 2179ff8..a97360f 100644
--- a/src/Socket.h
+++ b/src/Socket.h
@@ -306,24 +306,26 @@ protected:
         if (messageQueue.empty()) {
 
             if (ssl) {
+              /* BEG Patched by firebase-cpp-sdk 00001-fix-want-write-crash.patch */
+              bool continue_loop = true;
+              do {
                 sent = SSL_write(ssl, message->data, message->length);
                 if (sent == (ssize_t) message->length) {
-                    wasTransferred = false;
-                    return true;
+                  wasTransferred = false;
+                  return true;
                 } else if (sent < 0) {
-                    switch (SSL_get_error(ssl, sent)) {
-                    case SSL_ERROR_WANT_READ:
-                        break;
-                    case SSL_ERROR_WANT_WRITE:
-                        if ((getPoll() & UV_WRITABLE) == 0) {
-                            setPoll(getPoll() | UV_WRITABLE);
-                            changePoll(this);
-                        }
-                        break;
-                    default:
-                        return false;
-                    }
+                  switch (SSL_get_error(ssl, sent)) {
+                  case SSL_ERROR_WANT_READ:
+                    continue_loop = false;
+                    break;
+                  case SSL_ERROR_WANT_WRITE:
+                    break;
+                  default:
+                    return false;
+                  }
                 }
+              }  while (continue_loop);
+              /* END Patched by firebase-cpp-sdk scripts/patch_websockets.py */
             } else {
                 sent = ::send(getFd(), message->data, message->length, MSG_NOSIGNAL);
                 if (sent == (ssize_t) message->length) {
-- 
2.32.0.93.g670b81a890-goog

